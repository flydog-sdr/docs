(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{377:function(e,t,s){"use strict";s.r(t);var r=s(18),a=Object(r.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"自建反向代理服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自建反向代理服务器"}},[e._v("#")]),e._v(" 自建反向代理服务器")]),e._v(" "),s("p",[e._v("FlyDog SDR Project 为购买了 FlyDog SDR 的用户免费提供反向代理服务，但用户亦可自行构建反向代理服务器。")]),e._v(" "),s("h2",{attrs:{id:"准备和要求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备和要求"}},[e._v("#")]),e._v(" 准备和要求")]),e._v(" "),s("p",[e._v("要构建反向代理服务器，用户需要做如下准备。")]),e._v(" "),s("ul",[s("li",[e._v("租用一个云服务器（IP 以 "),s("code",[e._v("1.2.3.4")]),e._v(" 为例）")]),e._v(" "),s("li",[e._v("购买一个域名（以 "),s("code",[e._v("example.org")]),e._v(" 为例）")])]),e._v(" "),s("p",[e._v("此外，对于所租用的云服务器还有如下要求。")]),e._v(" "),s("ul",[s("li",[e._v("该云服务器运行内存不少于 512 MB（可通过配置 Swapfile 扩充运行内存）")]),e._v(" "),s("li",[e._v("该云服务器至少有一个公网 IP 地址")]),e._v(" "),s("li",[e._v("该云服务器有适合的流量配额")])]),e._v(" "),s("p",[e._v("在下文中，在云服务器的操作以 CentOS 为例。")]),e._v(" "),s("h2",{attrs:{id:"搭建运行环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建运行环境"}},[e._v("#")]),e._v(" 搭建运行环境")]),e._v(" "),s("p",[e._v("通过 SSH 登入云服务器，安装 Docker。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ curl -fsSL get.docker.com | sudo bash\n[centos@flydog-server ~]$ sudo usermod -aG docker ${USER}\n[centos@flydog-server ~]$ sudo systemctl enable docker\n\n")])])]),s("p",[e._v("安装并启用 Docker 后，重启云服务器。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ sudo reboot\n\n")])])]),s("p",[e._v("重启完成后，通过 SSH 重新连接到服务器，并安装 Git。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ sudo yum install -y git\n\n")])])]),s("h2",{attrs:{id:"拉取配置并构建镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拉取配置并构建镜像"}},[e._v("#")]),e._v(" 拉取配置并构建镜像")]),e._v(" "),s("p",[e._v("将 FlyDog SDR Project 提供的反向代理服务器配置自 GitHub 拉取至用户根目录（该目录及目录名不可改变）。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ git clone https://github.com/flydog-sdr/reverse-proxy ~/reverse-proxy\n\n")])])]),s("p",[e._v("构建 Frps，这是用于和 FlyDog SDR 对接的 NAT 穿透工具的服务器端，构建过程约 3-5 分钟。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ docker build -f ${HOME}/reverse-proxy/docker/frps/Dockerfile -t frps:latest\n\n")])])]),s("h2",{attrs:{id:"自定义配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自定义配置"}},[e._v("#")]),e._v(" 自定义配置")]),e._v(" "),s("p",[e._v("在部署应用前，需要修改一些配置，否则应用会报错。")]),e._v(" "),s("p",[e._v("下述命令中，"),s("code",[e._v("example.org")]),e._v(" 是要写入配置文件的域名。该域名用于 Frp 客户端（Frpc）接入服务器，以及供访客访问 FlyDog SDR 实例。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('[centos@flydog-server ~]$ sed -i "s/YOUR_DOMAIN/example.org/g" `grep -lr "YOUR_DOMAIN" ${HOME}/reverse-proxy/*`\n\n')])])]),s("p",[e._v("此外，用户需要修改用于 Frp 客户端登入至服务器时的凭据。FlyDog SDR Project 推荐使用 UUID 作为认证凭据。")]),e._v(" "),s("p",[e._v("下述命令中，"),s("code",[e._v("c62868fd-5889-4904-8145-d57b5104cb64")]),e._v(" 即 Frp 客户端登入所需之凭据。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('[centos@flydog-server ~]$ sed -i "s/YOUR_UUID/c62868fd-5889-4904-8145-d57b5104cb64/g" ${HOME}/reverse-proxy/config/frp/frps.ini\n\n')])])]),s("h2",{attrs:{id:"部署应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署应用"}},[e._v("#")]),e._v(" 部署应用")]),e._v(" "),s("p",[e._v("创建一个 Docker 网桥，用于容器之间的直接通信。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ docker network create -d bridge reverse-proxy\n\n")])])]),s("p",[e._v("首先部署 Frps。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ docker run -d \\\n --hostname frps \\\n --name frps \\\n --network reverse-proxy \\\n --restart always \\\n --volume ${HOME}/reverse-proxy/config/frp:/etc/frp \\\n frps:latest\n\n")])])]),s("p",[e._v("然后部署 PHP。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@flydog-server ~]$ docker run -d \\\n --hostname php \\\n --name php \\\n --network reverse-proxy \\\n --restart always \\\n --volume ${HOME}/reverse-proxy/htdocs:/var/www \\\n php:7.4-fpm-alpine\n\n")])])]),s("p",[e._v("最后部署 Nginx。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[centos@ip-172-26-19-76 ~]$ docker run -d \\\n --hostname nginx \\\n --name nginx \\\n --network reverse-proxy \\\n --publish 80:80 \\\n --restart always \\\n --volume ${HOME}/reverse-proxy/config/nginx:/etc/nginx \\\n --volume ${HOME}/reverse-proxy/htdocs:/var/www \\\n --volume /var/log/nginx:/var/log/nginx \\\n nginx:stable-alpine\n\n")])])]),s("p",[e._v("检查容器运行状态，此时三个容器都应在正常运行中。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('[centos@ip-172-26-19-76 ~]$ docker ps\nCONTAINER ID   IMAGE                 COMMAND                  CREATED          STATUS          PORTS                               NAMES\nd990b1839f13   php:7.4-fpm-alpine    "docker-php-entrypoi…"   33 seconds ago   Up 33 seconds   9000/tcp                            php\nc0a8d3521340   nginx:stable-alpine   "/docker-entrypoint.…"   40 seconds ago   Up 40 seconds   0.0.0.0:80->80/tcp, :::80->80/tcp   nginx\n023904ff1bea   frps:latest           "frps -c /etc/frp/fr…"   57 seconds ago   Up 57 seconds                                       frps\n\n')])])]),s("h2",{attrs:{id:"添加域名解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加域名解析"}},[e._v("#")]),e._v(" 添加域名解析")]),e._v(" "),s("p",[e._v("在域名提供商处，添加两个记录")]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[e._v("类型")]),e._v(" "),s("th",{staticStyle:{"text-align":"left"}},[e._v("名称")]),e._v(" "),s("th",{staticStyle:{"text-align":"left"}},[e._v("值")])])]),e._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[e._v("A")]),e._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[e._v("@")])]),e._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[e._v("1.2.3.4")])])]),e._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[e._v("A")]),e._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[e._v("*")])]),e._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[e._v("1.2.3.4")])])])])]),e._v(" "),s("p",[s("code",[e._v("@")]),e._v(" 代表根域，即 "),s("code",[e._v("example.org")]),e._v("。")]),e._v(" "),s("p",[s("code",[e._v("*")]),e._v(" 为通配符，匹配 "),s("code",[e._v("*.example.org")]),e._v("。")]),e._v(" "),s("h2",{attrs:{id:"应用该节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#应用该节点"}},[e._v("#")]),e._v(" 应用该节点")]),e._v(" "),s("p",[e._v("前往 FlyDog SDR 后台管理，转到 Network 标签页，将 Proxy server hostname 表单中的 "),s("code",[e._v("p.sdrotg.com")]),e._v(" 修改为 "),s("code",[e._v("example.org")]),e._v("，并根据系统提示，重启 FlyDog SDR 应用。")]),e._v(" "),s("p",[s("img",{attrs:{src:"/developer/reverse_1.png",alt:"Change proxy server hostname",title:"Change proxy server hostname"}})]),e._v(" "),s("p",[e._v("重启完成后，再次进入 FlyDog SDR 后台管理，转到 Connect 标签页，在 Reverse proxy configuration 表单中填入新的反向代理资讯。")]),e._v(" "),s("p",[e._v("按下 Click to (re)register，等待页面返回 Existing account, registration successful，即说明注册成功。")]),e._v(" "),s("p",[s("img",{attrs:{src:"/developer/reverse_2.png",alt:"Reregister",title:"Reregister"}})]),e._v(" "),s("p",[e._v("滑动到页面上半部分，再次选中 Reverse Proxy 以更新反向代理服务，并根据系统提示再次重启应用。")]),e._v(" "),s("p",[e._v("重启完成后，即可使用新的地址来访问，如 "),s("code",[e._v("flydog.example.com")]),e._v("。")])])}),[],!1,null,null,null);t.default=a.exports}}]);